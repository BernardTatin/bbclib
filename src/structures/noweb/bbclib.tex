\documentclass{scrartcl}% ===> this file was generated automatically by noweave --- better not edit it

\input{common/prelude.tex}

\author{Bernard Tatin}
\date{2013/2017}
\title{bbclib, une bibliothèque C}
\begin{document}

%% \pagestyle{noweb}
\maketitle
\abstract{Voici un premier essai de \emph{literate programming}, concept inventé par D. Knuth il y a plus de trente ans. À partir de ce seul fichier on génère la documentation et le code. Ici, je reprend du vieux code, cela m'oblige, même s'il est simple, à le repenser et donc, espérons le, à l'améliorer. Même si je passe beaucoup de temps sur la présentation... \\
\\
Ce code est très orienté \emph{embarqué} car il a été développé principalement dans cette optique. C'est pour cela que certaines gestions d'erreur n'ont pas été développées, faute de place. Il en est de même pour d'autres choix qui pourront paraître curieux au lecteur. \\
\\
Pour finir cette présentation, les fichiers crées à partir du document maître comme les sources et le PDF sont inclus dans ce dépôt pour permettre une visualisation simple des résultats obtenus sans avoir à installer quoique ce soit de spécial dont \texttt{noweb} et \LaTeX.}

\tableofcontents
\nwfilename{bbclib.nw}\nwfilename{rbuffer.nw}\nwbegindocs{0}\part{rbuffer}

C'est un buffer tournant le plus simple possible, capable de gérer des lignes délimitées par \emph{LF} (\texttt{'$\backslash$n'}) mais \emph{CR} (\texttt{'$\backslash$r'}) n'est pas pris en compte, plus exactement, il est rejetté.

\section{premières définitions}
Pour limiter les calculs, le code..., la taille du buffer est une puissance de 2 d'où la définition du nombre de bits qui ouvre le bal, et en tenant compte du fait que cette définition peut-être donnée en paramètre du préprocesseur :

\nwenddocs{}\nwbegincode{1}\sublabel{NWhQHnA-2Sh6y8-1}\nwmargintag{{\nwtagstyle{}\subpageref{NWhQHnA-2Sh6y8-1}}}\moddef{intro-bits~{\nwtagstyle{}\subpageref{NWhQHnA-2Sh6y8-1}}}\endmoddef\nwstartdeflinemarkup\nwusesondefline{\\{NWhQHnA-H2ln1-1}}\nwprevnextdefs{\relax}{NWhQHnA-2Sh6y8-2}\nwenddeflinemarkup
# if !defined(\nwlinkedidentc{_RBUFFER_BITS}{NWhQHnA-2Sh6y8-1})
#define \nwlinkedidentc{_RBUFFER_BITS}{NWhQHnA-2Sh6y8-1}   8\nwindexdefn{\nwixident{{\_}RBUFFER{\_}BITS}}{:unRBUFFER:unBITS}{NWhQHnA-2Sh6y8-1}
#endif
\nwalsodefined{\\{NWhQHnA-2Sh6y8-2}\\{NWhQHnA-2Sh6y8-3}}\nwused{\\{NWhQHnA-H2ln1-1}}\nwidentdefs{\\{{\nwixident{{\_}RBUFFER{\_}BITS}}{:unRBUFFER:unBITS}}}\nwendcode{}

\nwixlogsorted{c}{{add-char}{NWhQHnA-4LzvSl-1}{\nwixd{NWhQHnA-4LzvSl-1}\nwixu{NWhQHnA-H2ln1-1}}}%
\nwixlogsorted{c}{{command-line}{NW2ZLWn6-2CUXU7-1}{\nwixd{NW2ZLWn6-2CUXU7-1}}}%
\nwixlogsorted{c}{{define-inline}{NWhQHnA-35V7Cx-1}{\nwixd{NWhQHnA-35V7Cx-1}\nwixu{NWhQHnA-1DPUas-1}}}%
\nwixlogsorted{c}{{define-int}{NWhQHnA-4YguA8-1}{\nwixd{NWhQHnA-4YguA8-1}\nwixu{NWhQHnA-H2ln1-1}}}%
\nwixlogsorted{c}{{define-volatile}{NWhQHnA-43E2er-1}{\nwixd{NWhQHnA-43E2er-1}\nwixu{NWhQHnA-H2ln1-1}}}%
\nwixlogsorted{c}{{end-of-line}{NWhQHnA-3wDRpw-1}{\nwixd{NWhQHnA-3wDRpw-1}}}%
\nwixlogsorted{c}{{get-char}{NWhQHnA-323doG-1}{\nwixd{NWhQHnA-323doG-1}\nwixu{NWhQHnA-H2ln1-1}}}%
\nwixlogsorted{c}{{has-chars}{NWhQHnA-2cjkIS-1}{\nwixd{NWhQHnA-2cjkIS-1}\nwixu{NWhQHnA-H2ln1-1}}}%
\nwixlogsorted{c}{{intro-bits}{NWhQHnA-2Sh6y8-1}{\nwixd{NWhQHnA-2Sh6y8-1}\nwixd{NWhQHnA-2Sh6y8-2}\nwixd{NWhQHnA-2Sh6y8-3}\nwixu{NWhQHnA-H2ln1-1}}}%
\nwixlogsorted{c}{{more-functions-c}{NWhQHnA-2kqdfQ-1}{\nwixd{NWhQHnA-2kqdfQ-1}\nwixd{NWhQHnA-2kqdfQ-2}\nwixu{NWhQHnA-2tY7kx-1}}}%
\nwixlogsorted{c}{{more-functions-h}{NWhQHnA-8LHhU-1}{\nwixd{NWhQHnA-8LHhU-1}\nwixu{NWhQHnA-H2ln1-1}}}%
\nwixlogsorted{c}{{rbuffer.c}{NWhQHnA-2tY7kx-1}{\nwixd{NWhQHnA-2tY7kx-1}}}%
\nwixlogsorted{c}{{rbuffer.h}{NWhQHnA-H2ln1-1}{\nwixd{NWhQHnA-H2ln1-1}}}%
\nwixlogsorted{c}{{standard.h}{NWhQHnA-1DPUas-1}{\nwixd{NWhQHnA-1DPUas-1}}}%
\nwixlogsorted{c}{{tsrbuffer}{NWhQHnA-35IAXm-1}{\nwixd{NWhQHnA-35IAXm-1}}}%
\nwixlogsorted{c}{{tsrbuffer-final}{NWhQHnA-2grPBU-1}{\nwixd{NWhQHnA-2grPBU-1}\nwixu{NWhQHnA-H2ln1-1}}}%
\nwixlogsorted{c}{{type-bool}{NWhQHnA-23GEUr-1}{\nwixd{NWhQHnA-23GEUr-1}\nwixu{NWhQHnA-1DPUas-1}}}%
\nwixlogsorted{i}{{\nwixident{{\_}{\_}rbuffer{\_}h{\_}{\_}}}{:un:unrbuffer:unh:un:un}}%
\nwixlogsorted{i}{{\nwixident{{\_}{\_}with{\_}irqs,}}{:un:unwith:unirqs:com}}%
\nwixlogsorted{i}{{\nwixident{{\_}RBUFFER{\_}BITS}}{:unRBUFFER:unBITS}}%
\nwixlogsorted{i}{{\nwixident{bool}}{bool}}%
\nwixlogsorted{i}{{\nwixident{false}}{false}}%
\nwixlogsorted{i}{{\nwixident{INCLUDE{\_}{\_}COMPAT{\_}{\_}STANDARD{\_}H{\_}}}{INCLUDE:un:unCOMPAT:un:unSTANDARD:unH:un}}%
\nwixlogsorted{i}{{\nwixident{INLINE}}{INLINE}}%
\nwixlogsorted{i}{{\nwixident{INT}}{INT}}%
\nwixlogsorted{i}{{\nwixident{no{\_}inline}}{no:uninline}}%
\nwixlogsorted{i}{{\nwixident{rbf{\_}add{\_}char}}{rbf:unadd:unchar}}%
\nwixlogsorted{i}{{\nwixident{rbf{\_}add{\_}line}}{rbf:unadd:unline}}%
\nwixlogsorted{i}{{\nwixident{rbf{\_}end{\_}of{\_}line}}{rbf:unend:unof:unline}}%
\nwixlogsorted{i}{{\nwixident{rbf{\_}get{\_}char}}{rbf:unget:unchar}}%
\nwixlogsorted{i}{{\nwixident{rbf{\_}get{\_}line}}{rbf:unget:unline}}%
\nwixlogsorted{i}{{\nwixident{RBUFFER{\_}MASK}}{RBUFFER:unMASK}}%
\nwixlogsorted{i}{{\nwixident{RBUFFER{\_}SIZE}}{RBUFFER:unSIZE}}%
\nwixlogsorted{i}{{\nwixident{true}}{true}}%
\nwixlogsorted{i}{{\nwixident{TSrbuffer}}{TSrbuffer}}%
\nwixlogsorted{i}{{\nwixident{VOLATILE}}{VOLATILE}}%
\nwbegindocs{2}\nwdocspar
La taille du buffer sera donc :

\nwenddocs{}\nwbegincode{3}\sublabel{NWhQHnA-2Sh6y8-2}\nwmargintag{{\nwtagstyle{}\subpageref{NWhQHnA-2Sh6y8-2}}}\moddef{intro-bits~{\nwtagstyle{}\subpageref{NWhQHnA-2Sh6y8-1}}}\plusendmoddef\nwstartdeflinemarkup\nwusesondefline{\\{NWhQHnA-H2ln1-1}}\nwprevnextdefs{NWhQHnA-2Sh6y8-1}{NWhQHnA-2Sh6y8-3}\nwenddeflinemarkup
#define \nwlinkedidentc{RBUFFER_SIZE}{NWhQHnA-2Sh6y8-2}    (1 \nwindexdefn{\nwixident{RBUFFER{\_}SIZE}}{RBUFFER:unSIZE}{NWhQHnA-2Sh6y8-2}<< \nwlinkedidentc{_RBUFFER_BITS}{NWhQHnA-2Sh6y8-1})
\nwused{\\{NWhQHnA-H2ln1-1}}\nwidentdefs{\\{{\nwixident{RBUFFER{\_}SIZE}}{RBUFFER:unSIZE}}}\nwidentuses{\\{{\nwixident{{\_}RBUFFER{\_}BITS}}{:unRBUFFER:unBITS}}}\nwindexuse{\nwixident{{\_}RBUFFER{\_}BITS}}{:unRBUFFER:unBITS}{NWhQHnA-2Sh6y8-2}\nwendcode{}\nwbegindocs{4}\nwdocspar
Et le masque permettant un rapide \emph{modulo} arithmétique avec un {\Tt{}and\nwendquote} binaire :
\nwenddocs{}\nwbegincode{5}\sublabel{NWhQHnA-2Sh6y8-3}\nwmargintag{{\nwtagstyle{}\subpageref{NWhQHnA-2Sh6y8-3}}}\moddef{intro-bits~{\nwtagstyle{}\subpageref{NWhQHnA-2Sh6y8-1}}}\plusendmoddef\nwstartdeflinemarkup\nwusesondefline{\\{NWhQHnA-H2ln1-1}}\nwprevnextdefs{NWhQHnA-2Sh6y8-2}{\relax}\nwenddeflinemarkup
#define \nwlinkedidentc{RBUFFER_MASK}{NWhQHnA-2Sh6y8-3}    (\nwlinkedidentc{RBUFFER_SIZE}{NWhQHnA-2Sh6y8-2} - 1)\nwindexdefn{\nwixident{RBUFFER{\_}MASK}}{RBUFFER:unMASK}{NWhQHnA-2Sh6y8-3}

\nwused{\\{NWhQHnA-H2ln1-1}}\nwidentdefs{\\{{\nwixident{RBUFFER{\_}MASK}}{RBUFFER:unMASK}}}\nwidentuses{\\{{\nwixident{RBUFFER{\_}SIZE}}{RBUFFER:unSIZE}}}\nwindexuse{\nwixident{RBUFFER{\_}SIZE}}{RBUFFER:unSIZE}{NWhQHnA-2Sh6y8-3}\nwendcode{}\nwbegindocs{6}\nwdocspar
\section{la structure}
La voici :

\nwenddocs{}\nwbegincode{7}\sublabel{NWhQHnA-35IAXm-1}\nwmargintag{{\nwtagstyle{}\subpageref{NWhQHnA-35IAXm-1}}}\moddef{tsrbuffer~{\nwtagstyle{}\subpageref{NWhQHnA-35IAXm-1}}}\endmoddef\nwstartdeflinemarkup\nwenddeflinemarkup

typedef struct \{
    volatile int in;
    volatile int out;
    volatile int line_count;
    volatile char buffer[\nwlinkedidentc{RBUFFER_SIZE}{NWhQHnA-2Sh6y8-2}];
\} \nwlinkedidentc{TSrbuffer}{NWhQHnA-35IAXm-1};\nwindexdefn{\nwixident{TSrbuffer}}{TSrbuffer}{NWhQHnA-35IAXm-1}

\nwnotused{tsrbuffer}\nwidentdefs{\\{{\nwixident{TSrbuffer}}{TSrbuffer}}}\nwidentuses{\\{{\nwixident{RBUFFER{\_}SIZE}}{RBUFFER:unSIZE}}}\nwindexuse{\nwixident{RBUFFER{\_}SIZE}}{RBUFFER:unSIZE}{NWhQHnA-35IAXm-1}\nwendcode{}\nwbegindocs{8}\nwdocspar
\subsection{les champs}
\subsection{remarques diverses}
Tous les membres de la structure sont définis comme {\Tt{}volatile\ int\nwendquote}. C'est important dans un système embarqué avec des interruptions pouvant manipuler le buffer. Sans {\Tt{}volatile\nwendquote}, une optimisation trop agressive pourrait placer une des valeurs entières dans un registre. En cas d'interruption modifiant cette valeur, le registre, lui, ne bougera pas et des caractères pourraient se perdre.
On pourrait définir un {\Tt{}\nwlinkedidentq{VOLATILE}{NWhQHnA-43E2er-1}\nwendquote} en fonction de l'architecture du type :

\nwenddocs{}\nwbegincode{9}\sublabel{NWhQHnA-43E2er-1}\nwmargintag{{\nwtagstyle{}\subpageref{NWhQHnA-43E2er-1}}}\moddef{define-volatile~{\nwtagstyle{}\subpageref{NWhQHnA-43E2er-1}}}\endmoddef\nwstartdeflinemarkup\nwusesondefline{\\{NWhQHnA-H2ln1-1}}\nwenddeflinemarkup

#if defined(__with_irqs)
  #define \nwlinkedidentc{VOLATILE}{NWhQHnA-43E2er-1} volatile
#else
  #define \nwlinkedidentc{VOLATILE}{NWhQHnA-43E2er-1}
#endif

\nwindexdefn{\nwixident{{\_}{\_}with{\_}irqs,}}{:un:unwith:unirqs:com}{NWhQHnA-43E2er-1}\nwindexdefn{\nwixident{VOLATILE}}{VOLATILE}{NWhQHnA-43E2er-1}\eatline
\nwused{\\{NWhQHnA-H2ln1-1}}\nwidentdefs{\\{{\nwixident{{\_}{\_}with{\_}irqs,}}{:un:unwith:unirqs:com}}\\{{\nwixident{VOLATILE}}{VOLATILE}}}\nwendcode{}\nwbegindocs{10}L'utilisation du type {\Tt{}int\nwendquote} permet d'utiliser le type entier permettant en général le meilleur compromis vitesse/taille. Mais ce n'est pas toujours vrai, tout dépend de l'architecture du processeur et des choix des concepteurs du compilateur. On va donc utiliser un {\Tt{}define\nwendquote} ce qui autorise la définition sur la igne de commande du compilateur, contrairement au {\Tt{}typedef\nwendquote}:

\nwenddocs{}\nwbegincode{11}\sublabel{NWhQHnA-4YguA8-1}\nwmargintag{{\nwtagstyle{}\subpageref{NWhQHnA-4YguA8-1}}}\moddef{define-int~{\nwtagstyle{}\subpageref{NWhQHnA-4YguA8-1}}}\endmoddef\nwstartdeflinemarkup\nwusesondefline{\\{NWhQHnA-H2ln1-1}}\nwenddeflinemarkup

#if !defined(\nwlinkedidentc{INT}{NWhQHnA-4YguA8-1})
#define \nwlinkedidentc{INT}{NWhQHnA-4YguA8-1} int\nwindexdefn{\nwixident{INT}}{INT}{NWhQHnA-4YguA8-1}
#endif
\nwindexdefn{\nwixident{INT}}{INT}{NWhQHnA-4YguA8-1}\eatline
\nwused{\\{NWhQHnA-H2ln1-1}}\nwidentdefs{\\{{\nwixident{INT}}{INT}}}\nwendcode{}\nwbegindocs{12}Ce qui donnerait au final :

\nwenddocs{}\nwbegincode{13}\sublabel{NWhQHnA-2grPBU-1}\nwmargintag{{\nwtagstyle{}\subpageref{NWhQHnA-2grPBU-1}}}\moddef{tsrbuffer-final~{\nwtagstyle{}\subpageref{NWhQHnA-2grPBU-1}}}\endmoddef\nwstartdeflinemarkup\nwusesondefline{\\{NWhQHnA-H2ln1-1}}\nwenddeflinemarkup

typedef struct \{
    \nwlinkedidentc{VOLATILE}{NWhQHnA-43E2er-1} \nwlinkedidentc{INT}{NWhQHnA-4YguA8-1} in;
    \nwlinkedidentc{VOLATILE}{NWhQHnA-43E2er-1} \nwlinkedidentc{INT}{NWhQHnA-4YguA8-1} out;
    \nwlinkedidentc{VOLATILE}{NWhQHnA-43E2er-1} \nwlinkedidentc{INT}{NWhQHnA-4YguA8-1} line_count;
    \nwlinkedidentc{VOLATILE}{NWhQHnA-43E2er-1} char buffer[\nwlinkedidentc{RBUFFER_SIZE}{NWhQHnA-2Sh6y8-2}];
\} \nwlinkedidentc{TSrbuffer}{NWhQHnA-35IAXm-1};\nwindexdefn{\nwixident{TSrbuffer}}{TSrbuffer}{NWhQHnA-2grPBU-1}

\nwindexdefn{\nwixident{TSrbuffer}}{TSrbuffer}{NWhQHnA-2grPBU-1}\eatline
\nwused{\\{NWhQHnA-H2ln1-1}}\nwidentdefs{\\{{\nwixident{TSrbuffer}}{TSrbuffer}}}\nwidentuses{\\{{\nwixident{INT}}{INT}}\\{{\nwixident{RBUFFER{\_}SIZE}}{RBUFFER:unSIZE}}\\{{\nwixident{VOLATILE}}{VOLATILE}}}\nwindexuse{\nwixident{INT}}{INT}{NWhQHnA-2grPBU-1}\nwindexuse{\nwixident{RBUFFER{\_}SIZE}}{RBUFFER:unSIZE}{NWhQHnA-2grPBU-1}\nwindexuse{\nwixident{VOLATILE}}{VOLATILE}{NWhQHnA-2grPBU-1}\nwendcode{}\nwbegindocs{14}Quoiqu'il en soit, il est fortement recommandé de lire la définition exacte du {\Tt{}\nwlinkedidentq{VOLATILE}{NWhQHnA-43E2er-1}\nwendquote} de votre compilateur, certaines variations pouvant rendre votre code totalement inefficace. Et d'autant plus que votre compilateur cible un système embarqué où les variations autour des standards sont choses communes.

Cependant, nous ne résolvons pas tous les problèmes, en particuliers ceux du \emph{multi-threading} qui sont laissés à l'utilisateur dans cette version.


\section{le fonctionnement}
\subsection{types et modificateurs}
On utilise {\Tt{}\nwlinkedidentq{bool}{NWhQHnA-23GEUr-1}\nwendquote} qui n'est pas défini avant \emph{C11} :
\nwenddocs{}\nwbegincode{15}\sublabel{NWhQHnA-23GEUr-1}\nwmargintag{{\nwtagstyle{}\subpageref{NWhQHnA-23GEUr-1}}}\moddef{type-bool~{\nwtagstyle{}\subpageref{NWhQHnA-23GEUr-1}}}\endmoddef\nwstartdeflinemarkup\nwusesondefline{\\{NWhQHnA-1DPUas-1}}\nwenddeflinemarkup
#ifndef no_c11
  #include <stdbool.h>
#else
typedef enum \{
  \nwlinkedidentc{false}{NWhQHnA-23GEUr-1} = 0,
  \nwlinkedidentc{true}{NWhQHnA-23GEUr-1} = 1
\} \nwlinkedidentc{bool}{NWhQHnA-23GEUr-1};\nwindexdefn{\nwixident{bool}}{bool}{NWhQHnA-23GEUr-1}
#ifndef \nwlinkedidentc{no_inline}{NWhQHnA-23GEUr-1}
  #define \nwlinkedidentc{no_inline}{NWhQHnA-23GEUr-1}
#endif
#endif

\nwindexdefn{\nwixident{bool}}{bool}{NWhQHnA-23GEUr-1}\nwindexdefn{\nwixident{no{\_}inline}}{no:uninline}{NWhQHnA-23GEUr-1}\nwindexdefn{\nwixident{false}}{false}{NWhQHnA-23GEUr-1}\nwindexdefn{\nwixident{true}}{true}{NWhQHnA-23GEUr-1}\eatline
\nwused{\\{NWhQHnA-1DPUas-1}}\nwidentdefs{\\{{\nwixident{bool}}{bool}}\\{{\nwixident{false}}{false}}\\{{\nwixident{no{\_}inline}}{no:uninline}}\\{{\nwixident{true}}{true}}}\nwendcode{}\nwbegindocs{16}Certaines fonctions sont {\Tt{}inline\nwendquote}. La diversité des compilateurs nous obligent à définir un {\Tt{}\nwlinkedidentq{INLINE}{NWhQHnA-35V7Cx-1}\nwendquote} ainsi (et nous ne couvrons pas tous les cas, loin de là):
\nwenddocs{}\nwbegincode{17}\sublabel{NWhQHnA-35V7Cx-1}\nwmargintag{{\nwtagstyle{}\subpageref{NWhQHnA-35V7Cx-1}}}\moddef{define-inline~{\nwtagstyle{}\subpageref{NWhQHnA-35V7Cx-1}}}\endmoddef\nwstartdeflinemarkup\nwusesondefline{\\{NWhQHnA-1DPUas-1}}\nwenddeflinemarkup
#if defined(with_watcominline)
        #define \nwlinkedidentc{INLINE}{NWhQHnA-35V7Cx-1} __inline
#elif !defined(\nwlinkedidentc{no_inline}{NWhQHnA-23GEUr-1})
        #define \nwlinkedidentc{INLINE}{NWhQHnA-35V7Cx-1} inline
#else
        #define \nwlinkedidentc{INLINE}{NWhQHnA-35V7Cx-1}
#endif
\nwindexdefn{\nwixident{INLINE}}{INLINE}{NWhQHnA-35V7Cx-1}\eatline
\nwused{\\{NWhQHnA-1DPUas-1}}\nwidentdefs{\\{{\nwixident{INLINE}}{INLINE}}}\nwidentuses{\\{{\nwixident{no{\_}inline}}{no:uninline}}}\nwindexuse{\nwixident{no{\_}inline}}{no:uninline}{NWhQHnA-35V7Cx-1}\nwendcode{}\nwbegindocs{18}\subsection{ajout d'un caractère}
Le fonctionnement est le suivant pour l'ajout d'un caractère :

\begin{packed_itemize}
  \item si le caractère est '$\backslash$r', on ne fait rien,
  \item on place le caractère dans le buffer à la position {\Tt{}in\nwendquote},
  \item on incrémente {\Tt{}in\nwendquote},
  \item si on atteint la limite du buffer, on positionne {\Tt{}in\nwendquote} à 0,
  \item si le caractère est '$\backslash$n', on incrémente {\Tt{}line{\_}count\nwendquote}.
\end{packed_itemize}

\nwenddocs{}\nwbegincode{19}\sublabel{NWhQHnA-4LzvSl-1}\nwmargintag{{\nwtagstyle{}\subpageref{NWhQHnA-4LzvSl-1}}}\moddef{add-char~{\nwtagstyle{}\subpageref{NWhQHnA-4LzvSl-1}}}\endmoddef\nwstartdeflinemarkup\nwusesondefline{\\{NWhQHnA-H2ln1-1}}\nwenddeflinemarkup
static \nwlinkedidentc{INLINE}{NWhQHnA-35V7Cx-1} void \nwlinkedidentc{rbf_add_char}{NWhQHnA-4LzvSl-1}(\nwlinkedidentc{TSrbuffer}{NWhQHnA-35IAXm-1} *rb, const char c) \{\nwindexdefn{\nwixident{rbf{\_}add{\_}char}}{rbf:unadd:unchar}{NWhQHnA-4LzvSl-1}
    if (c != '\\r') \{
        rb->buffer[rb->in++] = c;
        rb->in &= \nwlinkedidentc{RBUFFER_MASK}{NWhQHnA-2Sh6y8-3};
        if (c == '\\n') \{
            rb->line_count++;
        \}
    \}
\}
\nwused{\\{NWhQHnA-H2ln1-1}}\nwidentdefs{\\{{\nwixident{rbf{\_}add{\_}char}}{rbf:unadd:unchar}}}\nwidentuses{\\{{\nwixident{INLINE}}{INLINE}}\\{{\nwixident{RBUFFER{\_}MASK}}{RBUFFER:unMASK}}\\{{\nwixident{TSrbuffer}}{TSrbuffer}}}\nwindexuse{\nwixident{INLINE}}{INLINE}{NWhQHnA-4LzvSl-1}\nwindexuse{\nwixident{RBUFFER{\_}MASK}}{RBUFFER:unMASK}{NWhQHnA-4LzvSl-1}\nwindexuse{\nwixident{TSrbuffer}}{TSrbuffer}{NWhQHnA-4LzvSl-1}\nwendcode{}\nwbegindocs{20}\nwdocspar
La récupération d'un caractère dans le buffer est l'algorithme inverse :

\nwenddocs{}\nwbegincode{21}\sublabel{NWhQHnA-323doG-1}\nwmargintag{{\nwtagstyle{}\subpageref{NWhQHnA-323doG-1}}}\moddef{get-char~{\nwtagstyle{}\subpageref{NWhQHnA-323doG-1}}}\endmoddef\nwstartdeflinemarkup\nwusesondefline{\\{NWhQHnA-H2ln1-1}}\nwenddeflinemarkup
static \nwlinkedidentc{INLINE}{NWhQHnA-35V7Cx-1} char \nwlinkedidentc{rbf_get_char}{NWhQHnA-323doG-1}(\nwlinkedidentc{TSrbuffer}{NWhQHnA-35IAXm-1} *rb) \{\nwindexdefn{\nwixident{rbf{\_}get{\_}char}}{rbf:unget:unchar}{NWhQHnA-323doG-1}
    \nwlinkedidentc{INT}{NWhQHnA-4YguA8-1} out = rb->out;
    char c = rb->buffer[out++];
    out &= \nwlinkedidentc{RBUFFER_MASK}{NWhQHnA-2Sh6y8-3};
    rb->out = out;
    if (c == '\\n' && rb->line_count) \{
        rb->line_count--;
    \}
    return c;
\}
\nwused{\\{NWhQHnA-H2ln1-1}}\nwidentdefs{\\{{\nwixident{rbf{\_}get{\_}char}}{rbf:unget:unchar}}}\nwidentuses{\\{{\nwixident{INLINE}}{INLINE}}\\{{\nwixident{INT}}{INT}}\\{{\nwixident{RBUFFER{\_}MASK}}{RBUFFER:unMASK}}\\{{\nwixident{TSrbuffer}}{TSrbuffer}}}\nwindexuse{\nwixident{INLINE}}{INLINE}{NWhQHnA-323doG-1}\nwindexuse{\nwixident{INT}}{INT}{NWhQHnA-323doG-1}\nwindexuse{\nwixident{RBUFFER{\_}MASK}}{RBUFFER:unMASK}{NWhQHnA-323doG-1}\nwindexuse{\nwixident{TSrbuffer}}{TSrbuffer}{NWhQHnA-323doG-1}\nwendcode{}\nwbegindocs{22}\nwdocspar
Il est cependant très important de déterminer si des caratères sont présents dans le buffer :
\nwenddocs{}\nwbegincode{23}\sublabel{NWhQHnA-2cjkIS-1}\nwmargintag{{\nwtagstyle{}\subpageref{NWhQHnA-2cjkIS-1}}}\moddef{has-chars~{\nwtagstyle{}\subpageref{NWhQHnA-2cjkIS-1}}}\endmoddef\nwstartdeflinemarkup\nwusesondefline{\\{NWhQHnA-H2ln1-1}}\nwenddeflinemarkup
static \nwlinkedidentc{INLINE}{NWhQHnA-35V7Cx-1} \nwlinkedidentc{bool}{NWhQHnA-23GEUr-1} rbf_has_chars(\nwlinkedidentc{TSrbuffer}{NWhQHnA-35IAXm-1} *rb) \{\nwindexdefn{\nwixident{bool}}{bool}{NWhQHnA-2cjkIS-1}
    return rb->in != rb->out;
\}
\nwused{\\{NWhQHnA-H2ln1-1}}\nwidentdefs{\\{{\nwixident{bool}}{bool}}}\nwidentuses{\\{{\nwixident{INLINE}}{INLINE}}\\{{\nwixident{TSrbuffer}}{TSrbuffer}}}\nwindexuse{\nwixident{INLINE}}{INLINE}{NWhQHnA-2cjkIS-1}\nwindexuse{\nwixident{TSrbuffer}}{TSrbuffer}{NWhQHnA-2cjkIS-1}\nwendcode{}\nwbegindocs{24}\nwdocspar
Le marquage d'une fin de ligne se fait par un '$\backslash$0' :
\nwenddocs{}\nwbegincode{25}\sublabel{NWhQHnA-3wDRpw-1}\nwmargintag{{\nwtagstyle{}\subpageref{NWhQHnA-3wDRpw-1}}}\moddef{end-of-line~{\nwtagstyle{}\subpageref{NWhQHnA-3wDRpw-1}}}\endmoddef\nwstartdeflinemarkup\nwenddeflinemarkup

static \nwlinkedidentc{INLINE}{NWhQHnA-35V7Cx-1} void \nwlinkedidentc{rbf_end_of_line}{NWhQHnA-3wDRpw-1}(\nwlinkedidentc{TSrbuffer}{NWhQHnA-35IAXm-1} *rb) \{\nwindexdefn{\nwixident{rbf{\_}end{\_}of{\_}line}}{rbf:unend:unof:unline}{NWhQHnA-3wDRpw-1}
    rb->buffer[rb->in] = 0;
    rb->line_count++;
\}

\nwnotused{end-of-line}\nwidentdefs{\\{{\nwixident{rbf{\_}end{\_}of{\_}line}}{rbf:unend:unof:unline}}}\nwidentuses{\\{{\nwixident{INLINE}}{INLINE}}\\{{\nwixident{TSrbuffer}}{TSrbuffer}}}\nwindexuse{\nwixident{INLINE}}{INLINE}{NWhQHnA-3wDRpw-1}\nwindexuse{\nwixident{TSrbuffer}}{TSrbuffer}{NWhQHnA-3wDRpw-1}\nwendcode{}\nwbegindocs{26}\nwdocspar
Ces fonctions, nécessitant une boucle, ne sont pas déclarées {\Tt{}\nwlinkedidentq{INLINE}{NWhQHnA-35V7Cx-1}\nwendquote} :
\nwenddocs{}\nwbegincode{27}\sublabel{NWhQHnA-8LHhU-1}\nwmargintag{{\nwtagstyle{}\subpageref{NWhQHnA-8LHhU-1}}}\moddef{more-functions-h~{\nwtagstyle{}\subpageref{NWhQHnA-8LHhU-1}}}\endmoddef\nwstartdeflinemarkup\nwusesondefline{\\{NWhQHnA-H2ln1-1}}\nwenddeflinemarkup
void \nwlinkedidentc{rbf_add_line}{NWhQHnA-2kqdfQ-1}(\nwlinkedidentc{TSrbuffer}{NWhQHnA-35IAXm-1} *rb, char *line);
\nwlinkedidentc{INT}{NWhQHnA-4YguA8-1} \nwlinkedidentc{rbf_get_line}{NWhQHnA-2kqdfQ-2}(\nwlinkedidentc{TSrbuffer}{NWhQHnA-35IAXm-1} *rb, char *line);
\nwused{\\{NWhQHnA-H2ln1-1}}\nwidentuses{\\{{\nwixident{INT}}{INT}}\\{{\nwixident{rbf{\_}add{\_}line}}{rbf:unadd:unline}}\\{{\nwixident{rbf{\_}get{\_}line}}{rbf:unget:unline}}\\{{\nwixident{TSrbuffer}}{TSrbuffer}}}\nwindexuse{\nwixident{INT}}{INT}{NWhQHnA-8LHhU-1}\nwindexuse{\nwixident{rbf{\_}add{\_}line}}{rbf:unadd:unline}{NWhQHnA-8LHhU-1}\nwindexuse{\nwixident{rbf{\_}get{\_}line}}{rbf:unget:unline}{NWhQHnA-8LHhU-1}\nwindexuse{\nwixident{TSrbuffer}}{TSrbuffer}{NWhQHnA-8LHhU-1}\nwendcode{}\nwbegindocs{28}\nwdocspar
L'ajout d'une ligne est \emph{simple} :
\nwenddocs{}\nwbegincode{29}\sublabel{NWhQHnA-2kqdfQ-1}\nwmargintag{{\nwtagstyle{}\subpageref{NWhQHnA-2kqdfQ-1}}}\moddef{more-functions-c~{\nwtagstyle{}\subpageref{NWhQHnA-2kqdfQ-1}}}\endmoddef\nwstartdeflinemarkup\nwusesondefline{\\{NWhQHnA-2tY7kx-1}}\nwprevnextdefs{\relax}{NWhQHnA-2kqdfQ-2}\nwenddeflinemarkup
void \nwlinkedidentc{rbf_add_line}{NWhQHnA-2kqdfQ-1}(\nwlinkedidentc{TSrbuffer}{NWhQHnA-35IAXm-1} *rb, char *line) \{\nwindexdefn{\nwixident{rbf{\_}add{\_}line}}{rbf:unadd:unline}{NWhQHnA-2kqdfQ-1}
    char c;

    while ((c = *(line++)) != 0) \{
        \nwlinkedidentc{rbf_add_char}{NWhQHnA-4LzvSl-1}(rb, c);
    \}
    \nwlinkedidentc{rbf_end_of_line}{NWhQHnA-3wDRpw-1}(rb);
\}
\nwalsodefined{\\{NWhQHnA-2kqdfQ-2}}\nwused{\\{NWhQHnA-2tY7kx-1}}\nwidentdefs{\\{{\nwixident{rbf{\_}add{\_}line}}{rbf:unadd:unline}}}\nwidentuses{\\{{\nwixident{rbf{\_}add{\_}char}}{rbf:unadd:unchar}}\\{{\nwixident{rbf{\_}end{\_}of{\_}line}}{rbf:unend:unof:unline}}\\{{\nwixident{TSrbuffer}}{TSrbuffer}}}\nwindexuse{\nwixident{rbf{\_}add{\_}char}}{rbf:unadd:unchar}{NWhQHnA-2kqdfQ-1}\nwindexuse{\nwixident{rbf{\_}end{\_}of{\_}line}}{rbf:unend:unof:unline}{NWhQHnA-2kqdfQ-1}\nwindexuse{\nwixident{TSrbuffer}}{TSrbuffer}{NWhQHnA-2kqdfQ-1}\nwendcode{}\nwbegindocs{30}\nwdocspar
Et la lecture d'une ligne :
\nwenddocs{}\nwbegincode{31}\sublabel{NWhQHnA-2kqdfQ-2}\nwmargintag{{\nwtagstyle{}\subpageref{NWhQHnA-2kqdfQ-2}}}\moddef{more-functions-c~{\nwtagstyle{}\subpageref{NWhQHnA-2kqdfQ-1}}}\plusendmoddef\nwstartdeflinemarkup\nwusesondefline{\\{NWhQHnA-2tY7kx-1}}\nwprevnextdefs{NWhQHnA-2kqdfQ-1}{\relax}\nwenddeflinemarkup
\nwlinkedidentc{INT}{NWhQHnA-4YguA8-1} \nwlinkedidentc{rbf_get_line}{NWhQHnA-2kqdfQ-2}(\nwlinkedidentc{TSrbuffer}{NWhQHnA-35IAXm-1} *rb, char *line) \{\nwindexdefn{\nwixident{rbf{\_}get{\_}line}}{rbf:unget:unline}{NWhQHnA-2kqdfQ-2}
    char c;
    \nwlinkedidentc{INT}{NWhQHnA-4YguA8-1} r = 0;

    while (rbf_has_chars(rb)) \{
        c = \nwlinkedidentc{rbf_get_char}{NWhQHnA-323doG-1}(rb);

        if (c == '\\n') \{
            break;
        \}
        if (c != 0) \{
            *(line++) = c;
        \}
        r++;
    \}
    *line = 0;
    return r;
\}
\nwused{\\{NWhQHnA-2tY7kx-1}}\nwidentdefs{\\{{\nwixident{rbf{\_}get{\_}line}}{rbf:unget:unline}}}\nwidentuses{\\{{\nwixident{INT}}{INT}}\\{{\nwixident{rbf{\_}get{\_}char}}{rbf:unget:unchar}}\\{{\nwixident{TSrbuffer}}{TSrbuffer}}}\nwindexuse{\nwixident{INT}}{INT}{NWhQHnA-2kqdfQ-2}\nwindexuse{\nwixident{rbf{\_}get{\_}char}}{rbf:unget:unchar}{NWhQHnA-2kqdfQ-2}\nwindexuse{\nwixident{TSrbuffer}}{TSrbuffer}{NWhQHnA-2kqdfQ-2}\nwendcode{}\nwbegindocs{32}\nwdocspar

\section{le code final}
\subsection{{\Tt{}standard.h\nwendquote}}
\nwenddocs{}\nwbegincode{33}\sublabel{NWhQHnA-1DPUas-1}\nwmargintag{{\nwtagstyle{}\subpageref{NWhQHnA-1DPUas-1}}}\moddef{standard.h~{\nwtagstyle{}\subpageref{NWhQHnA-1DPUas-1}}}\endmoddef\nwstartdeflinemarkup\nwenddeflinemarkup
/*
 * _standard.h
 * generated by noweb
 */
#ifndef \nwlinkedidentc{INCLUDE__COMPAT__STANDARD_H_}{NWhQHnA-1DPUas-1}
#define \nwlinkedidentc{INCLUDE__COMPAT__STANDARD_H_}{NWhQHnA-1DPUas-1}\nwindexdefn{\nwixident{INCLUDE{\_}{\_}COMPAT{\_}{\_}STANDARD{\_}H{\_}}}{INCLUDE:un:unCOMPAT:un:unSTANDARD:unH:un}{NWhQHnA-1DPUas-1}

#include <stdlib.h>
#include <stdarg.h>

\LA{}type-bool~{\nwtagstyle{}\subpageref{NWhQHnA-23GEUr-1}}\RA{}

\LA{}define-inline~{\nwtagstyle{}\subpageref{NWhQHnA-35V7Cx-1}}\RA{}

#endif /* \nwlinkedidentc{INCLUDE__COMPAT__STANDARD_H_}{NWhQHnA-1DPUas-1} */
\nwnotused{standard.h}\nwidentdefs{\\{{\nwixident{INCLUDE{\_}{\_}COMPAT{\_}{\_}STANDARD{\_}H{\_}}}{INCLUDE:un:unCOMPAT:un:unSTANDARD:unH:un}}}\nwendcode{}\nwbegindocs{34}\nwdocspar
\subsection{{\Tt{}rbuffer.h\nwendquote}}
\nwenddocs{}\nwbegincode{35}\sublabel{NWhQHnA-H2ln1-1}\nwmargintag{{\nwtagstyle{}\subpageref{NWhQHnA-H2ln1-1}}}\moddef{rbuffer.h~{\nwtagstyle{}\subpageref{NWhQHnA-H2ln1-1}}}\endmoddef\nwstartdeflinemarkup\nwenddeflinemarkup
/*
 * rbuffer.h
 * generated by noweb
 */

#if !defined(\nwlinkedidentc{__rbuffer_h__}{NWhQHnA-H2ln1-1})
#define \nwlinkedidentc{__rbuffer_h__}{NWhQHnA-H2ln1-1}\nwindexdefn{\nwixident{{\_}{\_}rbuffer{\_}h{\_}{\_}}}{:un:unrbuffer:unh:un:un}{NWhQHnA-H2ln1-1}

\LA{}intro-bits~{\nwtagstyle{}\subpageref{NWhQHnA-2Sh6y8-1}}\RA{}

\LA{}define-volatile~{\nwtagstyle{}\subpageref{NWhQHnA-43E2er-1}}\RA{}
\LA{}define-int~{\nwtagstyle{}\subpageref{NWhQHnA-4YguA8-1}}\RA{}

\LA{}tsrbuffer-final~{\nwtagstyle{}\subpageref{NWhQHnA-2grPBU-1}}\RA{}

\LA{}add-char~{\nwtagstyle{}\subpageref{NWhQHnA-4LzvSl-1}}\RA{}

\LA{}get-char~{\nwtagstyle{}\subpageref{NWhQHnA-323doG-1}}\RA{}

\LA{}has-chars~{\nwtagstyle{}\subpageref{NWhQHnA-2cjkIS-1}}\RA{}

\LA{}more-functions-h~{\nwtagstyle{}\subpageref{NWhQHnA-8LHhU-1}}\RA{}

#endif // \nwlinkedidentc{__rbuffer_h__}{NWhQHnA-H2ln1-1}
\nwnotused{rbuffer.h}\nwidentdefs{\\{{\nwixident{{\_}{\_}rbuffer{\_}h{\_}{\_}}}{:un:unrbuffer:unh:un:un}}}\nwendcode{}\nwbegindocs{36}\nwdocspar
\subsection{{\Tt{}rbuffer.c\nwendquote}}
\nwenddocs{}\nwbegincode{37}\sublabel{NWhQHnA-2tY7kx-1}\nwmargintag{{\nwtagstyle{}\subpageref{NWhQHnA-2tY7kx-1}}}\moddef{rbuffer.c~{\nwtagstyle{}\subpageref{NWhQHnA-2tY7kx-1}}}\endmoddef\nwstartdeflinemarkup\nwenddeflinemarkup
/*
 * rbuffer.c
 * generated by noweb
 */

#include "rbuffer.h"

\LA{}more-functions-c~{\nwtagstyle{}\subpageref{NWhQHnA-2kqdfQ-1}}\RA{}
\nwnotused{rbuffer.c}\nwendcode{}\nwbegindocs{38}\nwdocspar
\nwenddocs{}\nwfilename{annexes.nw}\nwbegindocs{0}\part{annexes}

\section{la ligne de commande}
Pour obtenir le fichier \LaTeX{} et le code source, voici ce qu'il faut faire depuis un terminal :

\nwenddocs{}\nwbegincode{1}\sublabel{NW2ZLWn6-2CUXU7-1}\nwmargintag{{\nwtagstyle{}\subpageref{NW2ZLWn6-2CUXU7-1}}}\moddef{command-line~{\nwtagstyle{}\subpageref{NW2ZLWn6-2CUXU7-1}}}\endmoddef\nwstartdeflinemarkup\nwenddeflinemarkup
# fichier LaTeX
noweave -delay -autodefs c -index rbuffer.nw > rbuffer.tex
# fichier PDF
pdflatex rbuffer.tex && \\
  pdflatex rbuffer.tex && \\
  pdflatex rbuffer.tex
# le code source
notangle rbuffer.nw > rbuffer.h
\nwnotused{command-line}\nwendcode{}\nwbegindocs{2}\nwdocspar
L'option {\Tt{}-autodefs\ c\nwendquote} permet à {\Tt{}noweave\nwendquote} de déterminer lui-même les éléments du langage C. Sans cette option, dans le cadre de ce fichier, les définitions de {\Tt{}intro-bits\nwendquote} ne seraient pas visibles.

\section{tables et index}
\subsection{table des extraits de code}

\nowebchunks

\subsection{index}

\nowebindex

\end{document}
\nwenddocs{}
