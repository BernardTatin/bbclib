\documentclass[10pt]{article}% ===> this file was generated automatically by noweave --- better not edit it

\input{prelude.tex}

\author{Bernard Tatin}
\date{2013/2017}
\title{rbuffer.h, un buffer tournant}
\begin{document}

\pagestyle{noweb}
\maketitle
\abstract{Voici un premier essai de \emph{literate programming}, concept inventé par D. Knuth il y a plus de trente ans. À partir de ce seul fichier on génère la documentation et le code. Ici, je reprend du vieux code, cela m'oblige, même s'il est simple, à le repenser et donc, espérons le, à l'améliorer.}
\tableofcontents
\section{rbuffer}

C'est un buffer tournant le plus simple possible, capable de gérer des lignes délimitées par \emph{LF} (\texttt{'$\backslash$n'}) mais \emph{CR} (\texttt{'$\backslash$r'}) n'est pas pris en compte.

\subsection{premières définitions}
Pour limiter les calculs, le code..., la taille du buffer est une puissance de 2 d'où la définition du nombre de bits qui ouvre le bal :

\nwfilename{rbuffer.nw}\nwbegincode{1}\sublabel{NWhQHnA-2Sh6y8-1}\nwmargintag{{\nwtagstyle{}\subpageref{NWhQHnA-2Sh6y8-1}}}\moddef{intro-bits~{\nwtagstyle{}\subpageref{NWhQHnA-2Sh6y8-1}}}\endmoddef\nwstartdeflinemarkup\nwusesondefline{\\{NWhQHnA-1p0Y9w-1}}\nwenddeflinemarkup
#define \nwlinkedidentc{_RBUFFER_BITS}{NWhQHnA-2Sh6y8-1}   8
#define \nwlinkedidentc{RBUFFER_SIZE}{NWhQHnA-2Sh6y8-1}    (1 << \nwlinkedidentc{_RBUFFER_BITS}{NWhQHnA-2Sh6y8-1})
#define \nwlinkedidentc{RBUFFER_MASK}{NWhQHnA-2Sh6y8-1}    (\nwlinkedidentc{RBUFFER_SIZE}{NWhQHnA-2Sh6y8-1} - 1)
\nwindexdefn{\nwixident{{\_}RBUFFER{\_}BITS}}{:unRBUFFER:unBITS}{NWhQHnA-2Sh6y8-1}\nwindexdefn{\nwixident{RBUFFER{\_}SIZE}}{RBUFFER:unSIZE}{NWhQHnA-2Sh6y8-1}\nwindexdefn{\nwixident{RBUFFER{\_}MASK}}{RBUFFER:unMASK}{NWhQHnA-2Sh6y8-1}\eatline
\nwused{\\{NWhQHnA-1p0Y9w-1}}\nwidentdefs{\\{{\nwixident{{\_}RBUFFER{\_}BITS}}{:unRBUFFER:unBITS}}\\{{\nwixident{RBUFFER{\_}MASK}}{RBUFFER:unMASK}}\\{{\nwixident{RBUFFER{\_}SIZE}}{RBUFFER:unSIZE}}}\nwendcode{}\nwbegindocs{2}\nwdocspar
\nwenddocs{}\nwbegindocs{3}\nwdocspar
\subsection{la structure}

\textbf{\textit{Note: }} tous les membres de la structure sont définis comme {\Tt{}volatile\nwendquote}. C'est important dans un système embarqué avec des interruptions pouvant manipuler le buffer. Sans {\Tt{}volatile\nwendquote}, une optimisation trop agressive pourrait placer une des valeurs entières dans un registre. En cas d'interruption modifiant cette valeur, le registre, lui, ne bougera pas et des caractères pourraient se perdre.

\nwenddocs{}\nwbegincode{4}\sublabel{NWhQHnA-35IAXm-1}\nwmargintag{{\nwtagstyle{}\subpageref{NWhQHnA-35IAXm-1}}}\moddef{tsrbuffer~{\nwtagstyle{}\subpageref{NWhQHnA-35IAXm-1}}}\endmoddef\nwstartdeflinemarkup\nwusesondefline{\\{NWhQHnA-1p0Y9w-1}}\nwenddeflinemarkup
/**
 * @struct \nwlinkedidentc{TSrbuffer}{NWhQHnA-35IAXm-1}
 * La structure gérant le buffer tournant.
 */
typedef struct \{
    volatile int in;
    volatile int out;
    volatile int line_count;
    volatile char buffer[\nwlinkedidentc{RBUFFER_SIZE}{NWhQHnA-2Sh6y8-1}];
\} \nwlinkedidentc{TSrbuffer}{NWhQHnA-35IAXm-1};
\nwindexdefn{\nwixident{TSrbuffer}}{TSrbuffer}{NWhQHnA-35IAXm-1}\eatline
\nwused{\\{NWhQHnA-1p0Y9w-1}}\nwidentdefs{\\{{\nwixident{TSrbuffer}}{TSrbuffer}}}\nwidentuses{\\{{\nwixident{RBUFFER{\_}SIZE}}{RBUFFER:unSIZE}}}\nwindexuse{\nwixident{RBUFFER{\_}SIZE}}{RBUFFER:unSIZE}{NWhQHnA-35IAXm-1}\nwendcode{}\nwbegindocs{5}\nwdocspar
\nwenddocs{}\nwbegindocs{6}\nwdocspar
\subsubsection{les champs}
\subsubsection{remarques diverses}
On pourrait définir un {\Tt{}VOLATILE\nwendquote} en fonction de l'architecture du type :

\nwenddocs{}\nwbegincode{7}\sublabel{NWhQHnA-43E2er-1}\nwmargintag{{\nwtagstyle{}\subpageref{NWhQHnA-43E2er-1}}}\moddef{define-volatile~{\nwtagstyle{}\subpageref{NWhQHnA-43E2er-1}}}\endmoddef\nwstartdeflinemarkup\nwenddeflinemarkup
#if defined(__with_irqs)
  #define VOLATILE volatile
#else
  #define VOLATILE
#endif

\nwnotused{define-volatile}\nwendcode{}\nwbegindocs{8}\nwdocspar
\subsection{le fonctionnement}
\subsubsection{ajout d'un caractère}
Le fonctionnement est le suivant pour l'ajout d'un caractère :

\begin{packed_itemize}
  \item on place le caractère dans le buffer à la position {\Tt{}in\nwendquote},
  \item on incrémente {\Tt{}in\nwendquote},
  \item si on atteint la limite du buffer, on positionne {\Tt{}in\nwendquote} à 0,
  \item si le caractère est '$\backslash$n', on incrémente {\Tt{}line{\_}count\nwendquote}.
\end{packed_itemize}


\nwenddocs{}\nwbegindocs{9}\nwdocspar
\subsection{le code final}

\nwenddocs{}\nwbegincode{10}\sublabel{NWhQHnA-1p0Y9w-1}\nwmargintag{{\nwtagstyle{}\subpageref{NWhQHnA-1p0Y9w-1}}}\moddef{*~{\nwtagstyle{}\subpageref{NWhQHnA-1p0Y9w-1}}}\endmoddef\nwstartdeflinemarkup\nwenddeflinemarkup
\LA{}intro-bits~{\nwtagstyle{}\subpageref{NWhQHnA-2Sh6y8-1}}\RA{}
\LA{}tsrbuffer~{\nwtagstyle{}\subpageref{NWhQHnA-35IAXm-1}}\RA{}

\nwnotused{*}\nwendcode{}

\nwixlogsorted{c}{{*}{NWhQHnA-1p0Y9w-1}{\nwixd{NWhQHnA-1p0Y9w-1}}}%
\nwixlogsorted{c}{{define-volatile}{NWhQHnA-43E2er-1}{\nwixd{NWhQHnA-43E2er-1}}}%
\nwixlogsorted{c}{{intro-bits}{NWhQHnA-2Sh6y8-1}{\nwixd{NWhQHnA-2Sh6y8-1}\nwixu{NWhQHnA-1p0Y9w-1}}}%
\nwixlogsorted{c}{{tsrbuffer}{NWhQHnA-35IAXm-1}{\nwixd{NWhQHnA-35IAXm-1}\nwixu{NWhQHnA-1p0Y9w-1}}}%
\nwixlogsorted{i}{{\nwixident{{\_}RBUFFER{\_}BITS}}{:unRBUFFER:unBITS}}%
\nwixlogsorted{i}{{\nwixident{RBUFFER{\_}MASK}}{RBUFFER:unMASK}}%
\nwixlogsorted{i}{{\nwixident{RBUFFER{\_}SIZE}}{RBUFFER:unSIZE}}%
\nwixlogsorted{i}{{\nwixident{TSrbuffer}}{TSrbuffer}}%
\nwbegindocs{11}\nwdocspar
\section{annexes}
\subsection{extraits de code}

\nowebchunks

\subsection{index}

\nowebindex

\end{document}
\nwenddocs{}
